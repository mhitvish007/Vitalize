<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#7fff6a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Vitalize">
<title>Vitalize ‚Äî Health Tracker</title>
<link rel="manifest" href="/manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* ===== TOKENS ===== */
:root {
  --bg: #080d08;
  --surface: #0f160f;
  --surface2: #151e15;
  --surface3: #1a241a;
  --accent: #7fff6a;
  --accent2: #4fc94a;
  --accent-dim: #2d5c2a;
  --text: #e2f0e2;
  --text-dim: #7a9e7a;
  --text-muted: #3e5c3e;
  --danger: #ff6b6b;
  --gold: #ffd56b;
  --border: #182018;
  --border2: #1e2c1e;
  --r: 18px;
  --glow: 0 0 30px rgba(127,255,106,0.12);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100%; overflow-x: hidden;
  padding-bottom: calc(80px + var(--safe-bot));
}
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 70% 35% at 15% 0%, rgba(127,255,106,0.07) 0%, transparent 65%),
    radial-gradient(ellipse 40% 40% at 85% 90%, rgba(79,201,74,0.04) 0%, transparent 65%);
}

/* ===== LAYOUT ===== */
.app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 0 16px; }

/* ===== TOP BAR ===== */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: calc(var(--safe-top) + 20px) 0 20px;
  position: sticky; top: 0; z-index: 50;
  background: linear-gradient(var(--bg) 85%, transparent);
}
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; color: var(--accent); letter-spacing: -0.5px; }
.logo em { color: var(--text-muted); font-style: normal; font-weight: 400; font-size: 13px; }
.topbar-right { display: flex; align-items: center; gap: 8px; }

.user-pill {
  display: flex; align-items: center; gap: 7px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 40px; padding: 5px 12px 5px 5px;
  cursor: pointer; transition: border-color 0.2s;
  -webkit-user-select: none; user-select: none;
}
.user-pill:active { border-color: var(--accent-dim); }
.avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--accent-dim); color: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-weight: 800; font-size: 11px;
  flex-shrink: 0;
}
.uname { font-size: 13px; font-weight: 500; color: var(--text); max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.icon-btn {
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--surface2); border: 1px solid var(--border2);
  color: var(--text-dim); display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 18px; transition: all 0.15s; flex-shrink: 0;
}
.icon-btn:active { border-color: var(--accent-dim); color: var(--accent); transform: scale(0.95); }

/* ===== GOOGLE FIT BANNER ===== */
.fit-banner {
  border-radius: var(--r); padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 20px; transition: all 0.3s; cursor: pointer;
}
.fit-banner.disconnected {
  background: var(--surface2); border: 1px dashed var(--border2);
}
.fit-banner.connected {
  background: rgba(127,255,106,0.06); border: 1px solid var(--accent-dim);
  box-shadow: var(--glow);
}
.fit-icon { font-size: 28px; flex-shrink: 0; }
.fit-text { flex: 1; }
.fit-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
.fit-disconnected .fit-title { color: var(--text-dim); }
.fit-connected .fit-title { color: var(--accent); }
.fit-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.fit-btn {
  background: var(--accent); color: var(--bg);
  border: none; border-radius: 10px; padding: 8px 14px;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px;
  cursor: pointer; white-space: nowrap; transition: all 0.15s; flex-shrink: 0;
}
.fit-btn:active { transform: scale(0.95); }
.fit-btn.outline {
  background: transparent; color: var(--text-dim); border: 1px solid var(--border2);
}

/* ===== SECTION LABEL ===== */
.sec { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 12px; }

/* ===== CARDS ===== */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 20px;
  margin-bottom: 14px;
}
.card.glowing { border-color: var(--accent-dim); box-shadow: var(--glow); }

/* ===== STEPS HERO ===== */
.steps-hero { text-align: center; padding: 28px 20px; }
.steps-ring-wrap { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
.steps-ring-wrap svg { transform: rotate(-90deg); }
.ring-bg { fill: none; stroke: var(--surface3); stroke-width: 10; }
.ring-fill {
  fill: none; stroke: url(#ringGrad); stroke-width: 10;
  stroke-linecap: round;
  stroke-dasharray: 440;
  stroke-dashoffset: 440;
  transition: stroke-dashoffset 0.8s cubic-bezier(0.34,1.56,0.64,1);
}
.steps-center {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.steps-big { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 32px; color: var(--accent); line-height: 1; }
.steps-unit { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.steps-goal-label { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; }
.steps-goal-label span { color: var(--accent2); font-weight: 600; }
.steps-pct { font-size: 12px; color: var(--text-muted); }

/* ===== LOG ROW ===== */
.log-row { display: flex; gap: 8px; }
.input {
  flex: 1; background: var(--surface2); border: 1px solid var(--border2);
  color: var(--text); border-radius: 12px; padding: 12px 14px;
  font-family: 'DM Sans', sans-serif; font-size: 15px;
  outline: none; transition: border-color 0.2s; -webkit-appearance: none;
}
.input:focus { border-color: var(--accent-dim); }
.input::placeholder { color: var(--text-muted); }
.btn {
  background: var(--accent); color: var(--bg);
  border: none; border-radius: 12px; padding: 12px 18px;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.btn:active { transform: scale(0.95); }
.btn.sm { padding: 8px 14px; font-size: 12px; border-radius: 10px; }
.btn.ghost { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border2); }
.btn.ghost:active { border-color: var(--accent-dim); }
.btn.danger-btn { background: var(--danger); color: #fff; }

/* ===== MINI STATS ===== */
.stats-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 14px; }
.stat-box { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 14px 12px; text-align: center; }
.stat-val { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 22px; color: var(--text); }
.stat-val.gold { color: var(--gold); }
.stat-val.green { color: var(--accent); }
.stat-lbl { font-size: 10px; color: var(--text-muted); margin-top: 3px; text-transform: uppercase; letter-spacing: 1px; }

/* ===== WEEK CHART ===== */
.week-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 5px; }
.day-col { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.day-lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
.day-bar-track { width: 100%; height: 60px; background: var(--surface2); border-radius: 6px; display: flex; align-items: flex-end; overflow: hidden; }
.day-bar { width: 100%; border-radius: 6px 6px 0 0; background: linear-gradient(180deg, var(--accent), var(--accent2)); transition: height 0.5s cubic-bezier(0.34,1.56,0.64,1); min-height: 2px; }
.day-num { font-size: 8px; color: var(--text-muted); }
.day-col.is-today .day-lbl { color: var(--accent); }
.day-col.is-today .day-bar { background: linear-gradient(180deg, #fff 0%, var(--accent) 100%); }

/* ===== GOALS ===== */
.goals-list { display: flex; flex-direction: column; gap: 8px; }
.goal-row {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 12px 14px;
  transition: all 0.2s;
}
.goal-row.checked { border-color: var(--accent-dim); background: rgba(127,255,106,0.04); }
.check-box {
  width: 22px; height: 22px; border-radius: 6px;
  border: 2px solid var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.15s; flex-shrink: 0;
  color: transparent; font-size: 13px;
}
.goal-row.checked .check-box { border-color: var(--accent); background: var(--accent); color: var(--bg); }
.goal-text { flex: 1; font-size: 14px; line-height: 1.3; }
.goal-row.checked .goal-text { color: var(--text-dim); text-decoration: line-through; }
.goal-streak { font-size: 10px; color: var(--gold); margin-right: 4px; }
.del-btn { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 2px 4px; line-height: 1; transition: color 0.15s; }
.del-btn:active { color: var(--danger); }

/* ===== MEMBERS LEADERBOARD ===== */
.member-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.member-row:last-child { border-bottom: none; }
.rank { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 16px; color: var(--text-muted); width: 20px; text-align: center; flex-shrink: 0; }
.rank.top { color: var(--gold); }
.member-info { flex: 1; min-width: 0; }
.member-name { font-size: 14px; font-weight: 500; color: var(--text); }
.member-email { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.member-steps-val { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; color: var(--accent); flex-shrink: 0; }
.member-del { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 4px; transition: color 0.15s; }
.member-del:active { color: var(--danger); }

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 50;
  background: rgba(8,13,8,0.9); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border2);
  display: flex; justify-content: space-around; align-items: center;
  padding: 10px 0 calc(10px + var(--safe-bot));
  max-width: 480px; margin: 0 auto;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  cursor: pointer; padding: 6px 16px; border-radius: 12px;
  transition: all 0.15s; -webkit-user-select: none;
}
.nav-item.active { background: rgba(127,255,106,0.08); }
.nav-icon { font-size: 22px; line-height: 1; }
.nav-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; }
.nav-item.active .nav-label { color: var(--accent); }

/* ===== PAGES ===== */
.page { display: none; padding-top: 8px; }
.page.active { display: block; }

/* ===== MODALS ===== */
.overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.sheet {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 24px 24px 0 0; padding: 0 20px calc(24px + var(--safe-bot));
  width: 100%; max-width: 480px;
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.overlay.open .sheet { transform: translateY(0); }
.sheet-handle { width: 40px; height: 4px; background: var(--border2); border-radius: 2px; margin: 14px auto 20px; }
.sheet-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; margin-bottom: 20px; }
.field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
.field label { font-size: 12px; color: var(--text-dim); font-weight: 500; }
.sheet-actions { display: flex; gap: 10px; margin-top: 8px; }

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: calc(90px + var(--safe-bot)); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface); border: 1px solid var(--accent-dim);
  border-radius: 12px; padding: 11px 18px;
  font-size: 13px; color: var(--accent);
  opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 999; white-space: nowrap; pointer-events: none;
  box-shadow: var(--glow);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== MISC ===== */
.flex-between { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.empty { text-align: center; padding: 30px 0; font-size: 14px; color: var(--text-muted); }
.sep { height: 1px; background: var(--border); margin: 16px 0; }
.tag { display: inline-block; background: rgba(127,255,106,0.1); color: var(--accent); border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 600; }
.month-title { font-family: 'Syne', sans-serif; font-size: 13px; color: var(--text-dim); }

/* ===== PROGRESS BAR ===== */
.prog-wrap { background: var(--surface3); border-radius: 99px; height: 5px; overflow: hidden; margin-top: 6px; }
.prog-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--accent2), var(--accent)); transition: width 0.5s; }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- APP -->
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="logo">Vitalize <em>Health</em></div>
    <div class="topbar-right">
      <div class="user-pill" onclick="openSheet('sheetUser')">
        <div class="avatar" id="topAvatar">?</div>
        <span class="uname" id="topName">Select user</span>
      </div>
      <div class="icon-btn" onclick="openSheet('sheetMember')" title="Add member">Ôºã</div>
    </div>
  </div>

  <!-- PAGE: HOME -->
  <div class="page active" id="pageHome">

    <!-- Google Fit Banner -->
    <div class="fit-banner disconnected" id="fitBanner" onclick="handleFitBanner()">
      <div class="fit-icon">üèÉ</div>
      <div class="fit-text">
        <div class="fit-title" id="fitTitle">Connect Google Fit</div>
        <div class="fit-sub" id="fitSub">Auto-sync your steps every time you open the app</div>
      </div>
      <button class="fit-btn" id="fitBtn">Connect</button>
    </div>

    <!-- Steps Hero -->
    <div class="card glowing" style="padding:0; overflow:hidden;">
      <div class="steps-hero">
        <div class="steps-ring-wrap">
          <svg width="160" height="160" viewBox="0 0 160 160">
            <defs>
              <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#4fc94a"/>
                <stop offset="100%" stop-color="#7fff6a"/>
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="80" cy="80" r="70"/>
            <circle class="ring-fill" id="ringFill" cx="80" cy="80" r="70"/>
          </svg>
          <div class="steps-center">
            <div class="steps-big" id="stepsNum">0</div>
            <div class="steps-unit">steps</div>
          </div>
        </div>
        <div class="steps-goal-label">Goal: <span id="stepsGoalLbl">10,000</span></div>
        <div class="steps-pct" id="stepsPctLbl">0% complete</div>
      </div>
      <div style="padding: 0 20px 20px; border-top: 1px solid var(--border); padding-top:16px;">
        <div class="log-row">
          <input class="input" type="number" id="stepsInput" placeholder="Add steps manually‚Ä¶" min="0" inputmode="numeric">
          <button class="btn" onclick="logSteps()">Log</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
          <input class="input" type="number" id="goalInput" placeholder="Change daily goal‚Ä¶" min="100" inputmode="numeric" style="font-size:13px; padding:9px 12px;">
          <button class="btn ghost sm" onclick="setGoal()">Set Goal</button>
        </div>
      </div>
    </div>

    <!-- Mini Stats -->
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-val gold" id="streakVal">0</div>
        <div class="stat-lbl">üî• Streak</div>
      </div>
      <div class="stat-box">
        <div class="stat-val green" id="weekVal">0</div>
        <div class="stat-lbl">Week Steps</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="goalsDoneVal">0/0</div>
        <div class="stat-lbl">Goals Done</div>
      </div>
    </div>

    <!-- Week Chart -->
    <div class="card">
      <div class="sec">This Week</div>
      <div class="week-grid" id="weekGrid"></div>
    </div>

  </div><!-- /pageHome -->

  <!-- PAGE: GOALS -->
  <div class="page" id="pageGoals">
    <div class="flex-between" style="margin-top:4px;">
      <div>
        <div class="sec" style="margin:0">Daily Goals</div>
        <div class="month-title" id="monthTitle"></div>
      </div>
      <button class="btn sm" onclick="openSheet('sheetGoal')">Ôºã Goal</button>
    </div>
    <div class="card">
      <div class="goals-list" id="goalsList"></div>
    </div>
  </div><!-- /pageGoals -->

  <!-- PAGE: GROUP -->
  <div class="page" id="pageGroup">
    <div class="flex-between" style="margin-top:4px;">
      <div class="sec" style="margin:0">Leaderboard ¬∑ Today</div>
      <button class="btn sm" onclick="openSheet('sheetMember')">Ôºã Member</button>
    </div>
    <div class="card" id="leaderboard"></div>

    <!-- Share section -->
    <div class="card" style="border-color:var(--accent-dim); box-shadow:var(--glow);">
      <div class="sec">Share With Your Group</div>
      <p style="font-size:13px; color:var(--text-dim); margin-bottom:14px; line-height:1.6;">
        Send this link to anyone ‚Äî they open it in their browser (mobile or desktop), add themselves as a member, and start tracking together.
      </p>
      <div style="background:var(--surface2); border:1px solid var(--border2); border-radius:10px; padding:10px 14px; font-size:11px; color:var(--text-muted); font-family:monospace; word-break:break-all; margin-bottom:12px;" id="shareUrlBox"></div>
      <button class="btn" onclick="copyLink()" style="width:100%">üìã Copy Link</button>
    </div>
  </div><!-- /pageGroup -->

</div><!-- /app -->

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="nav-item active" id="nav0" onclick="switchPage(0)">
    <div class="nav-icon">üè†</div>
    <div class="nav-label">Home</div>
  </div>
  <div class="nav-item" id="nav1" onclick="switchPage(1)">
    <div class="nav-icon">‚úÖ</div>
    <div class="nav-label">Goals</div>
  </div>
  <div class="nav-item" id="nav2" onclick="switchPage(2)">
    <div class="nav-icon">üë•</div>
    <div class="nav-label">Group</div>
  </div>
</div>

<!-- SHEET: Add Member -->
<div class="overlay" id="sheetMember" onclick="sheetOutside(event,'sheetMember')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Add Member</div>
    <div class="field">
      <label>Full Name</label>
      <input class="input" id="mName" placeholder="e.g. Priya Sharma">
    </div>
    <div class="field">
      <label>Email Address</label>
      <input class="input" id="mEmail" type="email" placeholder="priya@example.com">
    </div>
    <p style="font-size:12px; color:var(--text-muted); margin-bottom:16px; line-height:1.7;">
      After adding, share the Group page link with them so they can open the app and switch to their profile.
    </p>
    <div class="sheet-actions">
      <button class="btn" onclick="addMember()" style="flex:1">Add Member</button>
      <button class="btn ghost" onclick="closeSheet('sheetMember')">Cancel</button>
    </div>
  </div>
</div>

<!-- SHEET: Switch User -->
<div class="overlay" id="sheetUser" onclick="sheetOutside(event,'sheetUser')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Switch Profile</div>
    <div id="profileList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;"></div>
    <button class="btn ghost" onclick="closeSheet('sheetUser')" style="width:100%">Close</button>
  </div>
</div>

<!-- SHEET: Add Goal -->
<div class="overlay" id="sheetGoal" onclick="sheetOutside(event,'sheetGoal')">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">New Daily Goal</div>
    <div class="field">
      <label>Goal Description</label>
      <input class="input" id="gText" placeholder="e.g. Drink 2L water, Meditate 10 min‚Ä¶">
    </div>
    <div class="sheet-actions">
      <button class="btn" onclick="addGoal()" style="flex:1">Add Goal</button>
      <button class="btn ghost" onclick="closeSheet('sheetGoal')">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG ‚Äî REPLACE WITH YOUR GOOGLE CLIENT ID
// ============================================================
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
const FIT_SCOPE = 'https://www.googleapis.com/auth/fitness.activity.read';

// ============================================================
// STATE
// ============================================================
const SK = 'vitalize_pwa_v2';
let S = {
  members: [],         // [{id,name,email}]
  uid: null,           // current user id
  goals: [],           // [{id,text}] shared
  data: {},            // {uid: {steps:{date:n}, checks:{date:{gid:bool}}, goal:n}}
  fitTokens: {},       // {uid: {access_token, expiry}}
};

const today = () => new Date().toISOString().split('T')[0];
const fmt = n => n >= 1000 ? (n/1000).toFixed(1)+'k' : String(n);
const initials = name => name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);

function ud(uid) {
  uid = uid || S.uid;
  if (!uid) return null;
  if (!S.data[uid]) S.data[uid] = { steps:{}, checks:{}, goal:10000 };
  return S.data[uid];
}
function cu() { return S.members.find(m => m.id === S.uid); }

// ============================================================
// PERSISTENCE
// ============================================================
async function save() {
  const json = JSON.stringify(S);
  try { await window.storage.set(SK, json, true); } catch(_){}
  try { localStorage.setItem(SK, json); } catch(_){}
}
async function load() {
  try {
    const r = await window.storage.get(SK, true);
    if (r?.value) { S = JSON.parse(r.value); return; }
  } catch(_){}
  try {
    const ls = localStorage.getItem(SK);
    if (ls) { S = JSON.parse(ls); return; }
  } catch(_){}
}

// ============================================================
// GOOGLE FIT
// ============================================================
let tokenClient;
function initGoogleAuth() {
  if (!window.google || GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: FIT_SCOPE,
    callback: async (resp) => {
      if (resp.error) { toast('Google auth failed: ' + resp.error); return; }
      const expiry = Date.now() + (resp.expires_in * 1000);
      S.fitTokens[S.uid] = { access_token: resp.access_token, expiry };
      await save();
      await syncFitSteps();
    }
  });
}

function handleFitBanner() {
  if (!S.uid) { toast('Select a profile first'); return; }
  const ft = S.fitTokens[S.uid];
  if (ft && ft.expiry > Date.now()) {
    // Already connected ‚Äî offer disconnect
    if (confirm('Disconnect Google Fit?')) {
      delete S.fitTokens[S.uid];
      save(); renderFitBanner();
    }
  } else {
    connectFit();
  }
}

function connectFit() {
  if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
    toast('‚ö†Ô∏è Add your Google Client ID to the code first!');
    return;
  }
  if (!tokenClient) { initGoogleAuth(); }
  if (!tokenClient) { toast('Google auth not loaded yet, try again'); return; }
  tokenClient.requestAccessToken();
}

async function syncFitSteps() {
  if (!S.uid) return;
  const ft = S.fitTokens[S.uid];
  if (!ft || ft.expiry < Date.now()) return;

  toast('Syncing from Google Fit‚Ä¶');
  const d = ud();
  const todayMs = new Date().setHours(0,0,0,0);
  const tomMs = todayMs + 86400000;

  const body = {
    aggregateBy: [{ dataTypeName: 'com.google.step_count.delta' }],
    bucketByTime: { durationMillis: 86400000 },
    startTimeMillis: todayMs,
    endTimeMillis: tomMs
  };

  try {
    const res = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + ft.access_token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    let steps = 0;
    json.bucket?.[0]?.dataset?.[0]?.point?.forEach(p => {
      steps += p.value?.[0]?.intVal || 0;
    });
    d.steps[today()] = steps;
    await save();
    render();
    toast(`‚úÖ Synced: ${steps.toLocaleString()} steps today`);
  } catch(e) {
    toast('Sync error: ' + e.message);
  }
}

function renderFitBanner() {
  const ft = S.fitTokens[S.uid];
  const connected = ft && ft.expiry > Date.now();
  const banner = document.getElementById('fitBanner');
  banner.className = 'fit-banner ' + (connected ? 'connected' : 'disconnected');
  document.getElementById('fitTitle').textContent = connected ? 'Google Fit Connected' : 'Connect Google Fit';
  document.getElementById('fitSub').textContent = connected ? 'Tap to sync ‚Ä¢ Steps auto-sync on load' : 'Auto-sync your steps every time you open the app';
  const btn = document.getElementById('fitBtn');
  btn.textContent = connected ? '‚Üª Sync Now' : 'Connect';
  btn.className = 'fit-btn' + (connected ? ' outline' : '');
  if (connected) btn.onclick = () => syncFitSteps();
  else btn.onclick = () => connectFit();
}

// ============================================================
// ACTIONS
// ============================================================
async function logSteps() {
  if (!S.uid) { toast('Select a profile first'); return; }
  const val = parseInt(document.getElementById('stepsInput').value);
  if (!val || val < 0) { toast('Enter valid steps'); return; }
  const d = ud(); const t = today();
  d.steps[t] = (d.steps[t] || 0) + val;
  document.getElementById('stepsInput').value = '';
  await save(); render(); toast(`+${val.toLocaleString()} steps logged!`);
}

async function setGoal() {
  if (!S.uid) { toast('Select a profile first'); return; }
  const val = parseInt(document.getElementById('goalInput').value);
  if (!val || val < 100) { toast('Minimum goal is 100 steps'); return; }
  ud().goal = val;
  document.getElementById('goalInput').value = '';
  await save(); render(); toast(`Goal set to ${val.toLocaleString()} steps`);
}

async function addMember() {
  const name = document.getElementById('mName').value.trim();
  const email = document.getElementById('mEmail').value.trim();
  if (!name) { toast('Enter a name'); return; }
  if (!email.includes('@')) { toast('Enter a valid email'); return; }
  const id = 'u' + Date.now();
  S.members.push({ id, name, email });
  if (!S.uid) S.uid = id;
  document.getElementById('mName').value = '';
  document.getElementById('mEmail').value = '';
  closeSheet('sheetMember');
  await save(); render(); toast(`${name} added!`);
}

async function deleteMember(id) {
  if (!confirm('Remove this member?')) return;
  S.members = S.members.filter(m => m.id !== id);
  delete S.data[id]; delete S.fitTokens[id];
  if (S.uid === id) S.uid = S.members[0]?.id || null;
  await save(); render();
}

function switchUser(id) {
  S.uid = id; save();
  closeSheet('sheetUser');
  renderFitBanner();
  render();
  toast(`Switched to ${cu()?.name}`);
  // Auto-sync if token available
  setTimeout(syncFitSteps, 300);
}

async function addGoal() {
  const text = document.getElementById('gText').value.trim();
  if (!text) { toast('Enter goal text'); return; }
  S.goals.push({ id: 'g' + Date.now(), text });
  document.getElementById('gText').value = '';
  closeSheet('sheetGoal');
  await save(); render(); toast('Goal added!');
}

async function deleteGoal(gid) {
  S.goals = S.goals.filter(g => g.id !== gid);
  await save(); render();
}

async function toggleGoal(gid) {
  if (!S.uid) { toast('Select a profile first'); return; }
  const d = ud(); const t = today();
  if (!d.checks[t]) d.checks[t] = {};
  d.checks[t][gid] = !d.checks[t][gid];
  await save(); render();
}

function copyLink() {
  navigator.clipboard.writeText(location.href)
    .then(() => toast('Link copied!'))
    .catch(() => toast('Copy: ' + location.href));
}

// ============================================================
// RENDER
// ============================================================
function render() {
  renderTopBar();
  renderFitBanner();
  renderSteps();
  renderStats();
  renderWeek();
  renderGoals();
  renderLeaderboard();
  renderDate();
  renderShareUrl();
}

function renderTopBar() {
  const u = cu();
  document.getElementById('topAvatar').textContent = u ? initials(u.name) : '?';
  document.getElementById('topName').textContent = u?.name || 'Select user';
}

function renderSteps() {
  const d = ud(); const t = today();
  const steps = d?.steps[t] || 0;
  const goal = d?.goal || 10000;
  const pct = Math.min(100, steps / goal * 100);
  const circ = 2 * Math.PI * 70; // 439.8

  document.getElementById('stepsNum').textContent = steps.toLocaleString();
  document.getElementById('stepsGoalLbl').textContent = goal.toLocaleString();
  document.getElementById('stepsPctLbl').textContent = Math.round(pct) + '% complete';
  document.getElementById('ringFill').style.strokeDashoffset = circ - (circ * pct / 100);
}

function renderStats() {
  const d = ud();
  // Streak
  let streak = 0;
  if (d) {
    const goal = d.goal || 10000;
    const check = new Date();
    for (let i = 0; i < 365; i++) {
      const s = check.toISOString().split('T')[0];
      if ((d.steps[s] || 0) >= goal) { streak++; check.setDate(check.getDate()-1); }
      else if (i === 0) { check.setDate(check.getDate()-1); } // today might not be done
      else break;
    }
  }
  // Week steps
  const weekDates = getWeekDates();
  const weekSteps = weekDates.reduce((s,dt) => s + (d?.steps[dt]||0), 0);
  // Goals today
  const checks = d?.checks[today()] || {};
  const done = S.goals.filter(g => checks[g.id]).length;

  document.getElementById('streakVal').textContent = streak;
  document.getElementById('weekVal').textContent = fmt(weekSteps);
  document.getElementById('goalsDoneVal').textContent = `${done}/${S.goals.length}`;
}

function getWeekDates() {
  const now = new Date(); const day = now.getDay();
  return Array.from({length:7}, (_,i) => {
    const d = new Date(now); d.setDate(now.getDate() - day + i);
    return d.toISOString().split('T')[0];
  });
}

function renderWeek() {
  const d = ud();
  const dates = getWeekDates(); const t = today();
  const goal = d?.goal || 10000;
  const maxS = Math.max(goal, ...dates.map(dt => d?.steps[dt]||0), 1);
  const labels = ['S','M','T','W','T','F','S'];
  document.getElementById('weekGrid').innerHTML = dates.map((dt,i) => {
    const s = d?.steps[dt] || 0;
    const h = Math.round(s/maxS*100);
    return `<div class="day-col ${dt===t?'is-today':''}">
      <div class="day-lbl">${labels[i]}</div>
      <div class="day-bar-track"><div class="day-bar" style="height:${h}%"></div></div>
      <div class="day-num">${s?fmt(s):''}</div>
    </div>`;
  }).join('');
}

function renderGoals() {
  const checks = ud()?.checks[today()] || {};
  const el = document.getElementById('goalsList');
  if (!S.goals.length) {
    el.innerHTML = '<div class="empty">No goals yet.<br>Tap <strong>Ôºã Goal</strong> to add one!</div>';
    return;
  }
  el.innerHTML = S.goals.map(g => {
    const done = checks[g.id] || false;
    // Calculate streak for this goal across members (just current user)
    let gStreak = 0;
    const d = ud();
    if (d) {
      const check = new Date();
      for (let i = 0; i < 90; i++) {
        const s = check.toISOString().split('T')[0];
        if (d.checks[s]?.[g.id]) { gStreak++; check.setDate(check.getDate()-1); }
        else if (i === 0) { check.setDate(check.getDate()-1); }
        else break;
      }
    }
    return `<div class="goal-row ${done?'checked':''}">
      <div class="check-box" onclick="toggleGoal('${g.id}')">${done?'‚úì':''}</div>
      <div class="goal-text">${g.text}</div>
      ${gStreak>1?`<span class="goal-streak">üî•${gStreak}</span>`:''}
      <button class="del-btn" onclick="deleteGoal('${g.id}')">√ó</button>
    </div>`;
  }).join('');
}

function renderLeaderboard() {
  const t = today();
  const sorted = [...S.members].sort((a,b) => {
    return (S.data[b.id]?.steps[t]||0) - (S.data[a.id]?.steps[t]||0);
  });
  const el = document.getElementById('leaderboard');
  if (!sorted.length) {
    el.innerHTML = '<div class="empty">No members yet.</div>'; return;
  }
  el.innerHTML = sorted.map((m,i) => {
    const steps = S.data[m.id]?.steps[t] || 0;
    const goal = S.data[m.id]?.goal || 10000;
    const pct = Math.min(100, Math.round(steps/goal*100));
    const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    return `<div class="member-row">
      <div class="rank ${i<3?'top':''}">${medal||i+1}</div>
      <div class="avatar" style="flex-shrink:0">${initials(m.name)}</div>
      <div class="member-info">
        <div class="member-name">${m.name} ${m.id===S.uid?'<span class="tag">you</span>':''}</div>
        <div class="member-email">${m.email}</div>
        <div class="prog-wrap"><div class="prog-fill" style="width:${pct}%"></div></div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div class="member-steps-val">${steps.toLocaleString()}</div>
        <div style="font-size:10px;color:var(--text-muted)">${pct}%</div>
      </div>
      ${m.id!==S.uid?`<button class="member-del" onclick="deleteMember('${m.id}')">√ó</button>`:''}
    </div>`;
  }).join('');
}

function renderDate() {
  const now = new Date();
  document.getElementById('monthTitle').textContent = now.toLocaleDateString('en-US', {month:'long', year:'numeric'});
}

function renderShareUrl() {
  const el = document.getElementById('shareUrlBox');
  if (el) el.textContent = location.href;
}

function renderUserSheet() {
  const el = document.getElementById('profileList');
  if (!S.members.length) {
    el.innerHTML = '<div class="empty">No members yet. Add one!</div>'; return;
  }
  el.innerHTML = S.members.map(m => `
    <div class="member-row" style="cursor:pointer; background:${m.id===S.uid?'rgba(127,255,106,0.06)':''}; border-radius:12px; padding:10px 12px; border:1px solid ${m.id===S.uid?'var(--accent-dim)':'var(--border)'};" onclick="switchUser('${m.id}')">
      <div class="avatar" style="flex-shrink:0">${initials(m.name)}</div>
      <div class="member-info">
        <div class="member-name">${m.name}</div>
        <div class="member-email">${m.email}</div>
      </div>
      ${m.id===S.uid?'<div style="color:var(--accent);font-size:20px;flex-shrink:0">‚úì</div>':''}
    </div>`).join('');
}

// ============================================================
// NAV
// ============================================================
const pages = ['pageHome','pageGoals','pageGroup'];
function switchPage(i) {
  pages.forEach((p,j) => {
    document.getElementById(p).classList.toggle('active', j===i);
    document.getElementById('nav'+j).classList.toggle('active', j===i);
  });
  if (i===2) renderLeaderboard();
}

// ============================================================
// SHEETS
// ============================================================
function openSheet(id) {
  if (id==='sheetUser') renderUserSheet();
  document.getElementById(id).classList.add('open');
}
function closeSheet(id) { document.getElementById(id).classList.remove('open'); }
function sheetOutside(e, id) { if (e.target.classList.contains('overlay')) closeSheet(id); }

// ============================================================
// TOAST
// ============================================================
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 2800);
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.getElementById('stepsInput').addEventListener('keydown', e => { if(e.key==='Enter') logSteps(); });
document.getElementById('gText').addEventListener('keydown', e => { if(e.key==='Enter') addGoal(); });
document.getElementById('mEmail').addEventListener('keydown', e => { if(e.key==='Enter') addMember(); });

// ============================================================
// PWA SERVICE WORKER
// ============================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

// ============================================================
// INIT
// ============================================================
async function init() {
  await load();
  render();
  // Auto-sync Google Fit on load if token valid
  if (S.uid && S.fitTokens[S.uid]?.expiry > Date.now()) {
    setTimeout(syncFitSteps, 1000);
  }
  // Init Google OAuth lib once loaded
  window.addEventListener('load', () => {
    if (window.google) initGoogleAuth();
  });
}

init();
</script>
</body>
</html>
